name: 'Infrastructure Setup'

on:
  push:
    branches: [ main ]
    paths: [ 'terraform/**' ]
  workflow_dispatch:
    inputs:
      deploy_eks:
        description: 'Deploy EKS cluster (expensive)'
        required: false
        default: 'false'
        type: boolean

env:
  AWS_REGION: 'us-east-2'
  PROJECT_NAME: 'github-actions-terraform'
  INSTANCE_TYPE: 't3.micro'
  ENVIRONMENT: 'production'

jobs:
  # 1ë‹¨ê³„: ê¸°ë³¸ ì¸í”„ë¼ (EC2, ECR)
  basic-infrastructure:
    name: 'Deploy Basic Infrastructure'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: '1.5.7'

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Create ECR Repository
      run: |
        # ECR ë¦¬í¬ì§€í† ë¦¬ ìƒì„± (Terraform ì™¸ë¶€ì—ì„œ)
        if ! aws ecr describe-repositories --repository-names ${{ env.PROJECT_NAME }}-app --region ${{ env.AWS_REGION }} >/dev/null 2>&1; then
          echo "ğŸ“¦ ECR ë¦¬í¬ì§€í† ë¦¬ ìƒì„± ì¤‘..."
          aws ecr create-repository \
            --repository-name ${{ env.PROJECT_NAME }}-app \
            --image-scanning-configuration scanOnPush=true \
            --region ${{ env.AWS_REGION }}
          echo "âœ… ECR ë¦¬í¬ì§€í† ë¦¬ ìƒì„± ì™„ë£Œ"
        else
          echo "âœ… ECR ë¦¬í¬ì§€í† ë¦¬ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤"
        fi

    - name: Terraform Init
      run: |
        cd terraform
        terraform init -input=false -reconfigure

    - name: Create terraform.tfvars
      run: |
        cd terraform
        cat > terraform.tfvars << EOF
        aws_region    = "${{ env.AWS_REGION }}"
        project_name  = "${{ env.PROJECT_NAME }}-${{ env.ENVIRONMENT }}"
        instance_type = "${{ env.INSTANCE_TYPE }}"
        environment   = "${{ env.ENVIRONMENT }}"
        EOF

    - name: Terraform Plan (Basic)
      run: |
        cd terraform
        # EKS ê´€ë ¨ íŒŒì¼ ì„ì‹œ ì œì™¸
        if [ "${{ inputs.deploy_eks }}" != "true" ]; then
          mv eks.tf eks.tf.bak || true
          mv eks-iam.tf eks-iam.tf.bak || true
        fi
        terraform plan -no-color

    - name: Terraform Apply (Basic)
      run: |
        cd terraform
        terraform apply -auto-approve
        echo "âœ… ê¸°ë³¸ ì¸í”„ë¼ ë°°í¬ ì™„ë£Œ"

    - name: Output Results
      run: |
        cd terraform
        echo "ğŸ‰ ë°°í¬ ê²°ê³¼:"
        terraform output
        
        # ECR URI ì¶œë ¥
        ECR_URI=$(aws ecr describe-repositories --repository-names ${{ env.PROJECT_NAME }}-app --query 'repositories[0].repositoryUri' --output text)
        echo "ğŸ“¦ ECR URI: $ECR_URI"

  # 2ë‹¨ê³„: EKS ë°°í¬ (ì„ íƒì‚¬í•­)
  eks-infrastructure:
    name: 'Deploy EKS (Optional)'
    runs-on: ubuntu-latest
    needs: basic-infrastructure
    if: inputs.deploy_eks == 'true'
    permissions:
      contents: read
      id-token: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: '1.5.7'

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Deploy EKS
      run: |
        cd terraform
        terraform init -input=false -reconfigure
        
        # EKS íŒŒì¼ ë³µì›
        mv eks.tf.bak eks.tf || true
        mv eks-iam.tf.bak eks-iam.tf || true
        
        # tfvars ì¬ìƒì„±
        cat > terraform.tfvars << EOF
        aws_region    = "${{ env.AWS_REGION }}"
        project_name  = "${{ env.PROJECT_NAME }}-${{ env.ENVIRONMENT }}"
        instance_type = "${{ env.INSTANCE_TYPE }}"
        environment   = "${{ env.ENVIRONMENT }}"
        EOF
        
        terraform plan -no-color
        terraform apply -auto-approve
        
        echo "âœ… EKS í´ëŸ¬ìŠ¤í„° ë°°í¬ ì™„ë£Œ"
        echo "â° í´ëŸ¬ìŠ¤í„° ì¤€ë¹„ê¹Œì§€ 15-20ë¶„ ì†Œìš”ë©ë‹ˆë‹¤"