name: 'Terraform Destroy'

# ìˆ˜ë™ìœ¼ë¡œë§Œ ì‹¤í–‰ ê°€ëŠ¥ (ì•ˆì „ì„ ìœ„í•´)
on:
  workflow_dispatch:
    inputs:
      confirm_destroy:
        description: 'ì •ë§ë¡œ ëª¨ë“  ì¸í”„ë¼ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (yes/no)'
        required: true
        default: 'no'
        type: choice
        options:
        - 'no'
        - 'yes'

env:
  AWS_REGION: 'us-east-1'
  TF_VERSION: '1.5.7'

jobs:
  terraform-destroy:
    name: 'Terraform Destroy'
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm_destroy == 'yes'
    
    permissions:
      contents: read
      id-token: write
    
    environment:
      name: production
    
    steps:
    - name: âš ï¸ Destruction Warning
      run: |
        echo "ğŸš¨ ê²½ê³ : ëª¨ë“  AWS ì¸í”„ë¼ê°€ ì‚­ì œë©ë‹ˆë‹¤!"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ì‚­ì œë  ìì›ë“¤:"
        echo "  - EKS í´ëŸ¬ìŠ¤í„° (sm-eks)"
        echo "  - EKS ë…¸ë“œ ê·¸ë£¹"
        echo "  - ECR ë¦¬í¬ì§€í† ë¦¬"
        echo "  - IAM ì—­í• ë“¤"
        echo "  - ë³´ì•ˆ ê·¸ë£¹"
        echo "  - S3 ë²„í‚· (terraform state)"
        echo "  - DynamoDB í…Œì´ë¸” (terraform lock)"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "â° 30ì´ˆ ëŒ€ê¸° ì¤‘... (ì·¨ì†Œí•˜ë ¤ë©´ Actionsì—ì„œ ì¤‘ë‹¨í•˜ì„¸ìš”)"
        sleep 30

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Terraform Init
      run: |
        cd terraform
        terraform init -input=false

    - name: Pre-Destroy Cleanup
      run: |
        echo "ğŸ§¹ ì‚¬ì „ ì •ë¦¬ ì‘ì—… ì¤‘..."
        
        # ECR ì´ë¯¸ì§€ë“¤ ì‚­ì œ (ECR ë¦¬í¬ì§€í† ë¦¬ ì‚­ì œë¥¼ ìœ„í•´)
        echo "ğŸ“¦ ECR ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘..."
        aws ecr list-images --repository-name github-actions-terraform-app --region ${{ env.AWS_REGION }} --query 'imageIds[*]' --output json > images.json || echo "ECR ë¦¬í¬ì§€í† ë¦¬ê°€ ì—†ê±°ë‚˜ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤."
        
        if [ -s images.json ] && [ "$(cat images.json)" != "[]" ]; then
          aws ecr batch-delete-image --repository-name github-actions-terraform-app --region ${{ env.AWS_REGION }} --image-ids file://images.json || echo "ì´ë¯¸ì§€ ì‚­ì œ ì‹¤íŒ¨ ë˜ëŠ” ì´ë¯¸ ì‚­ì œë¨"
        fi
        
        # EKS í´ëŸ¬ìŠ¤í„°ì˜ LoadBalancer ì„œë¹„ìŠ¤ë“¤ ì •ë¦¬
        echo "ğŸ”§ EKS LoadBalancer ì„œë¹„ìŠ¤ ì •ë¦¬ ì¤‘..."
        aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name sm-eks || echo "EKS í´ëŸ¬ìŠ¤í„°ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        kubectl delete service --all -n default --timeout=300s || echo "ì„œë¹„ìŠ¤ ì‚­ì œ ì‹¤íŒ¨ ë˜ëŠ” ì´ë¯¸ ì‚­ì œë¨"
        
        echo "âœ… ì‚¬ì „ ì •ë¦¬ ì™„ë£Œ"

    - name: Terraform Plan Destroy
      id: plan_destroy
      run: |
        cd terraform
        echo "ğŸ“‹ ì‚­ì œ ê³„íš í™•ì¸ ì¤‘..."
        terraform plan -destroy -no-color -out=destroy.tfplan
        terraform show -no-color destroy.tfplan

    - name: Terraform Destroy
      id: destroy
      run: |
        cd terraform
        echo "ğŸ—‘ï¸ ì¸í”„ë¼ ì‚­ì œ ì‹œì‘..."
        terraform destroy -auto-approve -no-color
        echo "âœ… Terraform ìì› ì‚­ì œ ì™„ë£Œ!"

    - name: Post-Destroy Cleanup
      run: |
        echo "ğŸ§¹ í›„ì† ì •ë¦¬ ì‘ì—… ì¤‘..."
        
        # S3 ë²„í‚· ê°•ì œ ì‚­ì œ (ë²„ì „ì´ ìˆëŠ” ê²½ìš°)
        echo "ğŸ—‘ï¸ S3 ë²„í‚· ì •ë¦¬ ì¤‘..."
        aws s3 rm s3://terraform-state-us-east-1-0ss4kx0a --recursive || echo "S3 ë²„í‚·ì´ ì´ë¯¸ ì‚­ì œë˜ì—ˆê±°ë‚˜ ì—†ìŠµë‹ˆë‹¤."
        aws s3 rb s3://terraform-state-us-east-1-0ss4kx0a --force || echo "S3 ë²„í‚· ì‚­ì œ ì‹¤íŒ¨ ë˜ëŠ” ì´ë¯¸ ì‚­ì œë¨"
        
        # DynamoDB í…Œì´ë¸” ì‚­ì œ í™•ì¸
        echo "ğŸ—‘ï¸ DynamoDB í…Œì´ë¸” í™•ì¸ ì¤‘..."
        aws dynamodb describe-table --table-name my-terraform-project-terraform-state-lock --region ${{ env.AWS_REGION }} || echo "DynamoDB í…Œì´ë¸”ì´ ì´ë¯¸ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."
        
        echo "âœ… í›„ì† ì •ë¦¬ ì™„ë£Œ"

    - name: Destruction Summary
      run: |
        echo ""
        echo "ğŸ‰ ì¸í”„ë¼ ì‚­ì œ ì™„ë£Œ!"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ì‚­ì œëœ ìì›ë“¤:"
        echo "  âœ… EKS í´ëŸ¬ìŠ¤í„° ë° ë…¸ë“œ ê·¸ë£¹"
        echo "  âœ… ECR ë¦¬í¬ì§€í† ë¦¬ ë° ì´ë¯¸ì§€ë“¤"
        echo "  âœ… IAM ì—­í•  ë° ì •ì±…ë“¤"
        echo "  âœ… ë³´ì•ˆ ê·¸ë£¹"
        echo "  âœ… S3 ë²„í‚· (terraform state)"
        echo "  âœ… DynamoDB í…Œì´ë¸” (terraform lock)"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ’° AWS ë¹„ìš©ì´ ë” ì´ìƒ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
        echo "ğŸ”„ í•„ìš”ì‹œ terraform applyë¡œ ë‹¤ì‹œ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."

  terraform-destroy-cancelled:
    name: 'Destroy Cancelled'
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm_destroy != 'yes'
    
    steps:
    - name: Cancellation Notice
      run: |
        echo "âŒ ì¸í”„ë¼ ì‚­ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ’¡ ì¸í”„ë¼ë¥¼ ì‚­ì œí•˜ë ¤ë©´:"
        echo "   1. Actions íƒ­ì—ì„œ 'Terraform Destroy' ì›Œí¬í”Œë¡œìš° ì„ íƒ"
        echo "   2. 'Run workflow' í´ë¦­"
        echo "   3. 'confirm_destroy'ë¥¼ 'yes'ë¡œ ì„ íƒ"
        echo "   4. 'Run workflow' ì‹¤í–‰"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"