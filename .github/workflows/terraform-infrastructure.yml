name: 'Terraform Infrastructure'

# terraform í´ë” ë³€ê²½ ì‹œì—ë§Œ ì‹¤í–‰
on:
  push:
    branches: [ main ]
    paths: 
      - 'terraform/**'
  pull_request:
    branches: [ main ]
    paths: 
      - 'terraform/**'
  workflow_dispatch:

env:
  AWS_REGION: 'us-east-1'
  TF_VERSION: '1.5.7'

jobs:
  terraform-plan:
    name: 'Terraform Plan'
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Terraform Init
      run: |
        cd terraform
        terraform init -input=false

    - name: Terraform Validate
      run: |
        cd terraform
        terraform validate

    - name: Terraform Format Check
      run: |
        cd terraform
        terraform fmt -check -recursive

    - name: Terraform Plan
      id: plan
      run: |
        cd terraform
        terraform plan -no-color -out=tfplan
        
        # Plan ê²°ê³¼ë¥¼ íŒŒì¼ë¡œ ì €ì¥
        terraform show -no-color tfplan > plan_output.txt
      continue-on-error: true

    - name: Comment PR with Plan
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const planOutput = fs.readFileSync('terraform/plan_output.txt', 'utf8');
          
          const output = `#### ğŸ—ï¸ Terraform Plan Results
          
          <details><summary>ğŸ“‹ Show Plan Details</summary>
          
          \`\`\`terraform
          ${planOutput.length > 10000 ? planOutput.substring(0, 10000) + '\n... (truncated)' : planOutput}
          \`\`\`
          
          </details>
          
          **Plan Status**: \`${{ steps.plan.outcome }}\`
          **Pusher**: @${{ github.actor }}
          **Action**: \`${{ github.event_name }}\`
          
          > ğŸ’¡ ì´ ê³„íšì„ ì ìš©í•˜ë ¤ë©´ PRì„ main ë¸Œëœì¹˜ì— ë¨¸ì§€í•˜ì„¸ìš”.`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          });

  terraform-apply:
    name: 'Terraform Apply'
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    permissions:
      contents: read
      id-token: write
    
    environment:
      name: production
      url: ${{ steps.outputs.outputs.ecr_url }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Terraform Init (Local State)
      run: |
        cd terraform
        terraform init -input=false

    - name: Terraform Apply (Create Backend Resources)
      id: apply
      run: |
        cd terraform
        echo "ğŸš€ S3 ë²„í‚·ê³¼ DynamoDB í…Œì´ë¸” ìƒì„± ì¤‘..."
        terraform apply -auto-approve -no-color
        echo "âœ… Backend ë¦¬ì†ŒìŠ¤ ìƒì„± ì™„ë£Œ!"

    - name: Configure Backend
      run: |
        cd terraform
        echo "ğŸ”„ Backend ì„¤ì • í™œì„±í™” ì¤‘..."
        
        # backend ì„¤ì • ì£¼ì„ í•´ì œ
        sed -i 's/  # backend "s3"/  backend "s3"/' main.tf
        sed -i 's/  #   bucket/    bucket/' main.tf
        sed -i 's/  #   key/    key/' main.tf
        sed -i 's/  #   region/    region/' main.tf
        sed -i 's/  #   dynamodb_table/    dynamodb_table/' main.tf
        sed -i 's/  #   encrypt/    encrypt/' main.tf
        sed -i 's/  # }/  }/' main.tf
        
        echo "âœ… Backend ì„¤ì • í™œì„±í™” ì™„ë£Œ"

    - name: Migrate to Remote Backend
      run: |
        cd terraform
        echo "ğŸ“¦ ë¡œì»¬ stateë¥¼ S3ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤‘..."
        terraform init -force-copy -input=false
        echo "âœ… Backend ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ!"

    - name: Get Terraform Outputs
      id: outputs
      run: |
        cd terraform
        ECR_URL=$(terraform output -raw ecr_repository_url 2>/dev/null || echo "")
        echo "ecr_url=$ECR_URL" >> $GITHUB_OUTPUT
        
        echo "ğŸ“‹ Terraform ì¶œë ¥ê°’:"
        terraform output

    - name: Deployment Summary
      run: |
        cd terraform
        echo ""
        echo "ğŸ‰ ì¸í”„ë¼ ë°°í¬ ì™„ë£Œ!"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“¦ ECR Repository: ${{ steps.outputs.outputs.ecr_url }}"
        echo "ğŸŒ Region: ${{ env.AWS_REGION }}"
        echo "ğŸ·ï¸  Environment: production"
        echo "â° ë°°í¬ ì‹œê°„: $(date)"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "ğŸ”— ë‹¤ìŒ ë‹¨ê³„:"
        echo "   - ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë³€ê²½ ì‹œ Docker ì´ë¯¸ì§€ê°€ ìë™ìœ¼ë¡œ ë¹Œë“œë©ë‹ˆë‹¤"
        echo "   - ECRì— í‘¸ì‹œëœ ì´ë¯¸ì§€ëŠ” Kubernetesì— ìë™ ë°°í¬ë©ë‹ˆë‹¤"

  terraform-plan-only:
    name: 'Terraform Plan (Manual)'
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    permissions:
      contents: read
      id-token: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Terraform Init
      run: |
        cd terraform
        terraform init -input=false

    - name: Terraform Plan
      run: |
        cd terraform
        echo "ğŸ“‹ í˜„ì¬ ì¸í”„ë¼ ìƒíƒœ í™•ì¸ ì¤‘..."
        terraform plan -no-color
        
        echo ""
        echo "ğŸ’¡ ë³€ê²½ì‚¬í•­ì„ ì ìš©í•˜ë ¤ë©´:"
        echo "   1. terraform í´ë”ì˜ íŒŒì¼ì„ ìˆ˜ì •"
        echo "   2. main ë¸Œëœì¹˜ì— í‘¸ì‹œ"
        echo "   3. ìë™ìœ¼ë¡œ terraform apply ì‹¤í–‰ë¨"